---
title: "Assessment 2 GY476"
output:
  html_document: default
  pdf_document: default
---



# SETUP: Load packages and set directories



```{r setup}
# Set working directory
wdir <- "/Users/dylanhillier/Library/CloudStorage/OneDrive-LondonSchoolofEconomics/GY476_Geographic_Information_System/assessment02"

# Load required packages
if(!require("tidyverse")) install.packages("tidyverse")
library(tidyverse)
library(ggplot2)
library(dplyr)
library(sf)
library(tmap)

# Create data directory if it doesn't exist
if(!dir.exists(file.path(wdir, "data"))) {
  dir.create(file.path(wdir, "data"))
}
ddir <- file.path(wdir, "data")
```


# DOWNLOAD DATA: Airbnb listings and neighbourhood boundaries



```{r download-data}
# Download Airbnb listings
download.file(
  url = "https://data.insideairbnb.com/united-states/ca/los-angeles/2025-09-01/visualisations/listings.csv",
  destfile = file.path(ddir, "listing.csv")
)

# Download neighbourhood boundaries
download.file(
  url = "https://data.insideairbnb.com/united-states/ca/los-angeles/2025-09-01/visualisations/neighbourhoods.geojson",
  destfile = file.path(ddir, "neighbourhoods.geojson")
)
```



# LOAD DATA: Read in all datasets



```{r load-data}
# Airbnb listings
airbnb_raw <- read.csv(file.path(ddir, "listing.csv"))

# Neighbourhood boundaries
neighbourhoods_sf <- st_read(file.path(ddir, "neighbourhoods.geojson"))

# LA census tract geometry
census_tracts_sf <- st_read(file.path(ddir, "LA_geometry.gpkg"))

# Census data
census_data <- read.csv(file.path(ddir, "ACS_2019_2023_LA_vars.csv")) %>%
  tibble() %>%
  mutate(
    GEOID = as.character(GEOID),
    GEOID = paste0("06", str_sub(GEOID, start = 2))
  )
```



# JOIN DATA: Combine census geometry with census data



```{r join-census}
census_joined <- census_tracts_sf %>%
  left_join(census_data, by = "GEOID")
```

# =============================================================================

# PREPARE AIRBNB DATA: Remove outliers and convert to spatial

# =============================================================================

```{r prepare-airbnb}
# Calculate IQR bounds for outlier removal
Q1 <- quantile(airbnb_raw$price, 0.25, na.rm = TRUE)
Q3 <- quantile(airbnb_raw$price, 0.75, na.rm = TRUE)
IQR_val <- Q3 - Q1

# Filter outliers and convert to sf object
airbnb_sf <- airbnb_raw %>%
  tibble() %>%
  filter(
    price >= (Q1 - 1.5 * IQR_val) & 
    price <= (Q3 + 1.5 * IQR_val)
  ) %>%
  st_as_sf(coords = c("longitude", "latitude")) %>%
  st_set_crs(32611)
```



# MAP 1: Interactive map of all Airbnb listings



```{r map-interactive}
tmap_mode("view")

tm_shape(airbnb_sf) +
  tm_dots(
    fill = "price",
    fill.scale = tm_scale_continuous(values = "Reds"),
    fill.legend = tm_legend(title = "Price ($)"),
    size = 0.5
  )
```



# MAP 2: Static map of listings with neighbourhood boundaries



```{r map-listings}
tmap_mode("plot")

map_listings <- tm_shape(neighbourhoods_sf) +
  tm_polygons(
    fill = "#f7f7f7",
    col = "#969696",
    lwd = 0.5,
    fill_alpha = 0.8
  ) +
tm_shape(airbnb_sf) +
  tm_dots(
    fill = "price",
    fill.scale = tm_scale_continuous(values = "YlOrRd"),
    fill.legend = tm_legend(title = "Price ($)", frame = FALSE),
    size = 0.15,
    col = "#00000020"
  ) +
tm_title("Airbnb Listing Prices in Los Angeles") +
tm_compass(type = "arrow", position = c("right", "top"), size = 1.5) +
tm_scalebar(position = c("left", "bottom"), width = 15) +
tm_layout(
  frame = FALSE,
  legend.outside = TRUE,
  legend.outside.position = "right"
)

map_listings

# Save map
tmap_save(
  map_listings,
  filename = file.path(ddir, "la_airbnb_map.png"),
  width = 10, height = 8, units = "in", dpi = 300, device = png
)
```



# MAP 3: Choropleth of mean price by neighbourhood



```{r map-choropleth}
# Fix invalid geometries
neighbourhoods_sf <- st_make_valid(neighbourhoods_sf)
airbnb_sf <- st_make_valid(airbnb_sf)

# Calculate mean price per neighbourhood
neighbourhood_prices <- airbnb_sf %>%
  st_join(neighbourhoods_sf) %>%
  st_drop_geometry() %>%
  group_by(neighbourhood.y) %>%
  summarise(mean_price = mean(price, na.rm = TRUE)) %>%
  rename(neighbourhood = neighbourhood.y)

# Join prices back to neighbourhood geometry
neighbourhoods_with_prices <- neighbourhoods_sf %>%
  left_join(neighbourhood_prices, by = "neighbourhood")

# Identify top 3 and bottom 3 neighbourhoods by price
highlight_neighbourhoods <- neighbourhoods_with_prices %>%
  filter(!is.na(mean_price)) %>%
  mutate(price_rank = rank(-mean_price)) %>%
  filter(price_rank <= 3 | price_rank >= (max(price_rank) - 2)) %>%
  mutate(
    category = ifelse(
      price_rank <= 3,
      paste0("High: ", neighbourhood, " ($", round(mean_price), ")"),
      paste0("Low: ", neighbourhood, " ($", round(mean_price), ")")
    )
  ) %>%
  st_centroid()

# Create choropleth map
tmap_mode("plot")

map_choropleth <- tm_shape(neighbourhoods_with_prices) +
  tm_fill(
    fill = "mean_price",
    fill.scale = tm_scale_continuous(values = "YlOrRd"),
    fill.legend = tm_legend(title = "Mean Price ($)")
  ) +
  tm_borders(col = "white", lwd = 0.5) +
tm_shape(highlight_neighbourhoods) +
  tm_symbols(
    fill = "category",
    fill.scale = tm_scale_categorical(
      values = c("darkred", "darkred", "darkred", "darkgreen", "darkgreen", "darkgreen")
    ),
    fill.legend = tm_legend(title = "Notable Areas"),
    size = 0.8,
    shape = 21,
    col = "white"
  ) +
tm_title("Mean Airbnb Price by Neighbourhood in Los Angeles") +
tm_compass(type = "arrow", position = c("right", "top"), size = 1.5) +
tm_scalebar(position = c("left", "bottom"), width = 15) +
tm_layout(
  frame = FALSE,
  legend.outside = TRUE,
  legend.outside.position = "right"
)

map_choropleth

# Save map
tmap_save(
  map_choropleth,
  filename = file.path(ddir, "la_choropleth_map.pdf"),
  width = 12, height = 10
)
```

figure 6

```{r}

acton_sf <- neighbourhoods_sf %>%
  filter(neighbourhood == "Acton") %>% st_as_sf() %>% st_transform(crs = 32611)
acton_airbnb 
ggplot() +
  geom_sf(data = acton_sf, aes(color = "black")) + 
  labs(title = "Restaurants within 200m Proximity in Acton")
  

theme_minimal()


```