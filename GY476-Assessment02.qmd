---
title: "Assessment 2 GY476"
output:
  html_document: default
  pdf_document: default
---

# =============================================================================
# SETUP: Load packages and set directories
# =============================================================================
```{r setup}
# Set working directory
wdir <- "/Users/dylanhillier/Library/CloudStorage/OneDrive-LondonSchoolofEconomics/GY476_Geographic_Information_System/assessment02"

# Load required packages
if(!require("tidyverse")) install.packages("tidyverse")
library(tidyverse)
library(ggplot2)
library(dplyr)
library(sf)
library(tmap)
library(tidycensus)
library(grid)

# Create data directory if it doesn't exist
if(!dir.exists(file.path(wdir, "data"))) {
  dir.create(file.path(wdir, "data"))
}
ddir <- file.path(wdir, "data")

# Census API key
census_api_key("c990ed72472399dd626592b06afee9a188d03320", install = TRUE, overwrite = TRUE)
```

# =============================================================================
# DOWNLOAD DATA: Airbnb listings and neighbourhood boundaries
# =============================================================================
```{r download-data}
# Download Airbnb listings
download.file(
  url = "https://data.insideairbnb.com/united-states/ca/los-angeles/2025-09-01/visualisations/listings.csv",
  destfile = file.path(ddir, "listing.csv")
)

# Download neighbourhood boundaries
download.file(
  url = "https://data.insideairbnb.com/united-states/ca/los-angeles/2025-09-01/visualisations/neighbourhoods.geojson",
  destfile = file.path(ddir, "neighbourhoods.geojson")
)
```

# =============================================================================
# LOAD DATA: Read in all datasets
# =============================================================================
```{r load-data}
# Airbnb listings
airbnb_raw <- read.csv(file.path(ddir, "listing.csv"))

# Neighbourhood boundaries
neighbourhoods_sf <- st_read(file.path(ddir, "neighbourhoods.geojson"))

# LA census tract geometry
census_tracts_sf <- st_read(file.path(ddir, "LA_geometry.gpkg")) %>%
  st_transform(32611)

# Census data
census_data <- read.csv(file.path(ddir, "ACS_2019_2023_LA_vars.csv")) %>%
  tibble() %>%
  mutate(
    GEOID = as.character(GEOID),
    GEOID = paste0("06", str_sub(GEOID, start = 2))
  )

# Define bounding boxes (reused for all maps)
mainland_bbox <- st_bbox(c(xmin = 320000, ymin = 3710000, 
                           xmax = 445000, ymax = 3860000), 
                         crs = 32611)

catalina_bbox <- st_bbox(c(xmin = 340000, ymin = 3678000, 
                           xmax = 390000, ymax = 3708000), 
                         crs = 32611)
```

# =============================================================================
# JOIN DATA: Combine census geometry with census data
# =============================================================================
```{r join-census}
census_joined <- census_tracts_sf %>%
  left_join(census_data, by = "GEOID")
```

# =============================================================================
# PREPARE AIRBNB DATA: Remove outliers and convert to spatial
# =============================================================================
```{r prepare-airbnb}
# Calculate IQR bounds for outlier removal
Q1 <- quantile(airbnb_raw$price, 0.25, na.rm = TRUE)
Q3 <- quantile(airbnb_raw$price, 0.75, na.rm = TRUE)
IQR_val <- Q3 - Q1

# Filter outliers and convert to sf object
airbnb_sf <- airbnb_raw %>%
  tibble() %>%
  filter(
    price >= (Q1 - 1.5 * IQR_val) & 
    price <= (Q3 + 1.5 * IQR_val)
  ) %>%
  st_as_sf(coords = c("longitude", "latitude")) %>%
  st_set_crs(4326) %>%      
  st_transform(32611) %>%
  st_make_valid()
```

# =============================================================================
# FIGURE 1: Airbnb Listings by Room Type (Two-panel map)
# =============================================================================
```{r figure-1}
# Split by room type
airbnb_entire <- airbnb_sf %>%
  filter(room_type == "Entire home/apt")

airbnb_other <- airbnb_sf %>%
  filter(room_type %in% c("Hotel room", "Private room", "Shared room"))

tmap_mode("plot")

# ---- Panel 1: Entire Home/Apartment ----
main_entire <- tm_shape(census_tracts_sf, bbox = mainland_bbox) +
  tm_borders(col = "grey70", lwd = 0.3) +
  tm_shape(airbnb_entire) +
  tm_dots(fill = "darkblue", size = 0.05, fill_alpha = 0.5) +
  tm_title("Entire Home/Apartment", fontface = "bold", size = 1.2) +
  tm_scalebar(position = c("left", "bottom"), width = 15) +
  tm_compass(type = "arrow", position = c("right", "top"), size = 2.4) +
  tm_layout(frame = TRUE)

inset_entire <- tm_shape(census_tracts_sf, bbox = catalina_bbox) +
  tm_fill(fill = "grey95") +
  tm_borders(col = "grey70", lwd = 0.5) +
  tm_shape(airbnb_entire) +
  tm_dots(fill = "darkblue", size = 0.2, fill_alpha = 0.7) +
  tm_title("Catalina Island", size = 0.7, fontface = "bold") +
  tm_layout(frame = TRUE, frame.lwd = 2, bg.color = "white")

# ---- Panel 2: Hotel/Private/Shared Room ----
main_other <- tm_shape(census_tracts_sf, bbox = mainland_bbox) +
  tm_borders(col = "grey70", lwd = 0.3) +
  tm_shape(airbnb_other) +
  tm_dots(fill = "darkred", size = 0.05, fill_alpha = 0.5) +
  tm_title("Hotel / Private / Shared Room", fontface = "bold", size = 1.2) +
  tm_scalebar(position = c("left", "bottom"), width = 15) +
  tm_compass(type = "arrow", position = c("right", "top"), size = 2.4) +
  tm_layout(frame = TRUE)

inset_other <- tm_shape(census_tracts_sf, bbox = catalina_bbox) +
  tm_fill(fill = "grey95") +
  tm_borders(col = "grey70", lwd = 0.5) +
  tm_shape(airbnb_other) +
  tm_dots(fill = "darkred", size = 0.2, fill_alpha = 0.7) +
  tm_title("Catalina Island", size = 0.7, fontface = "bold") +
  tm_layout(frame = TRUE, frame.lwd = 2, bg.color = "white")

# ---- Save Figure 1 ----
png(file.path(ddir, "figure_1_room_types.png"), width = 14, height = 8, units = "in", res = 300)
grid.newpage()
pushViewport(viewport(layout = grid.layout(1, 2)))
pushViewport(viewport(layout.pos.col = 1))
print(main_entire, vp = viewport(x = 0.5, y = 0.5, width = 0.95, height = 0.95))
print(inset_entire, vp = viewport(x = 0.78, y = 0.17, width = 0.22, height = 0.28))
popViewport()
pushViewport(viewport(layout.pos.col = 2))
print(main_other, vp = viewport(x = 0.5, y = 0.5, width = 0.95, height = 0.95))
print(inset_other, vp = viewport(x = 0.78, y = 0.17, width = 0.22, height = 0.28))
popViewport()
dev.off()
```

# =============================================================================
# FIGURE 2: Mean Airbnb Price by Census Tract (Choropleth)
# =============================================================================
```{r figure-2}
# Fix invalid geometries
census_tracts_sf <- st_make_valid(census_tracts_sf)
airbnb_sf <- st_make_valid(airbnb_sf)

# Calculate mean price per census tract
tract_prices <- airbnb_sf %>%
  st_join(census_tracts_sf) %>%
  st_drop_geometry() %>%
  group_by(GEOID) %>%
  summarise(mean_price = mean(price, na.rm = TRUE))

# Join prices back to census tract geometry
tracts_with_prices <- census_tracts_sf %>%
  left_join(tract_prices, by = "GEOID")

# Identify top 3 and bottom 3 tracts by price
all_highlight <- tracts_with_prices %>%
  filter(!is.na(mean_price)) %>%
  mutate(price_rank = rank(-mean_price, ties.method = "first")) %>%
  filter(price_rank <= 3 | price_rank >= (max(price_rank) - 2)) %>%
  mutate(
    type = ifelse(price_rank <= 3, "Highest", "Lowest"),
    label = case_when(
      price_rank == 1 ~ "1st Highest",
      price_rank == 2 ~ "2nd Highest",
      price_rank == 3 ~ "3rd Highest",
      price_rank == max(price_rank) ~ "1st Lowest",
      price_rank == max(price_rank) - 1 ~ "2nd Lowest",
      price_rank == max(price_rank) - 2 ~ "3rd Lowest"
    )
  ) %>%
  st_centroid()

# Split into highest and lowest
highest_tracts <- all_highlight %>% 
  filter(type == "Highest") %>%
  mutate(label = factor(label, levels = c("1st Highest", "2nd Highest", "3rd Highest")))

lowest_tracts <- all_highlight %>% 
  filter(type == "Lowest") %>%
  mutate(label = factor(label, levels = c("1st Lowest", "2nd Lowest", "3rd Lowest")))

# ---- Main Map (Mainland) ----
tmap_mode("plot")

main_choropleth <- tm_shape(tracts_with_prices, bbox = mainland_bbox) +
  tm_fill(
    fill = "mean_price",
    fill.scale = tm_scale_continuous(values = "YlOrRd"),
    fill.legend = tm_legend(title = "Mean Price ($)")
  ) +
  tm_borders(col = "grey70", lwd = 0.2) +
  tm_shape(highest_tracts) +
  tm_symbols(
    shape = "label",
    shape.scale = tm_scale_categorical(values = c(24, 25, 23)),
    shape.legend = tm_legend(title = "Highest Price"),
    fill = "#DAA520", size = 0.8, col = "black", lwd = 1.2
  ) +
  tm_shape(lowest_tracts) +
  tm_symbols(
    shape = "label",
    shape.scale = tm_scale_categorical(values = c(21, 22, 8)),
    shape.legend = tm_legend(title = "Lowest Price"),
    fill = "#ee1616", size = 0.8, col = "black", lwd = 1.2
  ) +
  tm_title("Mean Airbnb Price by Census Tract", fontface = "bold", size = 1.2) +
  tm_compass(type = "arrow", position = c("right", "top"), size = 2.4) +
  tm_scalebar(position = c("left", "bottom"), width = 15) +
  tm_layout(frame = TRUE, legend.outside = TRUE, legend.outside.position = "right")

# ---- Inset Map (Catalina Island) ----
inset_choropleth <- tm_shape(tracts_with_prices, bbox = catalina_bbox) +
  tm_fill(
    fill = "mean_price",
    fill.scale = tm_scale_continuous(values = "YlOrRd"),
    fill.legend = NULL
  ) +
  tm_borders(col = "grey70", lwd = 0.3) +
  tm_title("Catalina Island", size = 1.0, fontface = "bold") +
  tm_layout(frame = TRUE, frame.lwd = 2, bg.color = "white", legend.show = FALSE)

# ---- Save Figure 2 ----
png(file.path(ddir, "figure_2_choropleth.png"), width = 12, height = 10, units = "in", res = 300)
grid.newpage()
print(main_choropleth, vp = viewport(x = 0.5, y = 0.5, width = 1, height = 1))
print(inset_choropleth, vp = viewport(x = 0.87, y = 0.145, width = 0.25, height = 0.25))
dev.off()
```

# =============================================================================
# FIGURE 3: Socio-economic Variables (Combined Panel)
# =============================================================================

# ---- 1. Data Preparation ----
# (Your existing code correctly standardizes renters by total units) 
# =============================================================================
# FIGURE 3: Socio-economic Variables (Combined Panel)
# =============================================================================

# ... [Keep your data preparation code from step 1 exactly the same] ...
```{r}
# ---- 2. Define Map Objects ----
tmap_mode("plot")

# -- Panel A: Renters --
main_renter <- tm_shape(renter_sf, bbox = mainland_bbox) +
  tm_polygons(
    fill = "pct_renter",
    fill.scale = tm_scale_continuous(values = "YlOrRd"),
    # Orientation landscape works best for bottom legends
    fill.legend = tm_legend(title = "Percentage Renters (%)", orientation = "landscape"), 
    col = "white", lwd = 0.1
  ) +
  tm_title("A: Renter Occupancy", fontface = "bold", size = 1.2) +
  tm_compass(type = "arrow", position = c("right", "top"), size = 1.5) +
  tm_scalebar(position = c("right", "bottom"), width = 10) +
  # CHANGE: Move legend outside to the bottom
  tm_layout(frame = TRUE, 
            legend.outside = TRUE, 
            legend.outside.position = "bottom",
            legend.outside.size = 0.2,
            inner.margins = c(0.02, 0.02, 0.02, 0.02))

inset_renter <- tm_shape(renter_sf, bbox = catalina_bbox) +
  tm_polygons(
    fill = "pct_renter",
    fill.scale = tm_scale_continuous(values = "YlOrRd"),
    fill.legend = tm_legend(show = FALSE),
    col = "white", lwd = 0.3
  ) +
  tm_title("Catalina Is.", size = 0.6, fontface = "bold") +
  tm_layout(frame = TRUE, frame.lwd = 1, bg.color = "white")

# -- Panel B: Income --
main_income <- tm_shape(Median_income_sf, bbox = mainland_bbox) +
  tm_polygons(
    fill = "Median_income",
    fill.scale = tm_scale_continuous(values = "GnBu"),
    # Orientation landscape works best for bottom legends
    fill.legend = tm_legend(title = "Median Income ($)", orientation = "landscape"),
    col = "white", lwd = 0.1
  ) +
  tm_title("B: Median Household Income", fontface = "bold", size = 1.2) +
  tm_compass(type = "arrow", position = c("right", "top"), size = 1.5) +
  tm_scalebar(position = c("right", "bottom"), width = 10) +
  # CHANGE: Move legend outside to the bottom
  tm_layout(frame = TRUE, 
            legend.outside = TRUE, 
            legend.outside.position = "bottom",
            legend.outside.size = 0.2,
            inner.margins = c(0.02, 0.02, 0.02, 0.02))

inset_income <- tm_shape(Median_income_sf, bbox = catalina_bbox) +
  tm_polygons(
    fill = "Median_income",
    fill.scale = tm_scale_continuous(values = "GnBu"),
    fill.legend = tm_legend(show = FALSE),
    col = "white", lwd = 0.3
  ) +
  tm_title("Catalina Is.", size = 0.6, fontface = "bold") +
  tm_layout(frame = TRUE, frame.lwd = 1, bg.color = "white")

# ---- 3. Render Combined Figure ----
png(file.path(ddir, "figure_3_socioeconomic_combined.png"), width = 14, height = 9, units = "in", res = 300)

grid.newpage()
pushViewport(viewport(layout = grid.layout(1, 2)))

# --- Left Column (Renters) ---
pushViewport(viewport(layout.pos.col = 1))
  print(main_renter, vp = viewport(x = 0.5, y = 0.5, width = 0.98, height = 0.98))
  # Adjusted y position slightly to account for the layout change
  print(inset_renter, vp = viewport(x = 0.78, y = 0.25, width = 0.22, height = 0.28))
popViewport()

# --- Right Column (Income) ---
pushViewport(viewport(layout.pos.col = 2))
  print(main_income, vp = viewport(x = 0.5, y = 0.5, width = 0.98, height = 0.98))
  # Adjusted y position slightly to account for the layout change
  print(inset_income, vp = viewport(x = 0.78, y = 0.25, width = 0.22, height = 0.28))
popViewport()

dev.off()
```

#figure 4

```{R}
library(ggplot2)
airbnb_raw
data_summary

```